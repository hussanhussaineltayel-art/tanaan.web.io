function toggleMobileMenu(){document.getElementById("main-nav").classList.toggle("active")}function cleanAIResponse(e){if(!e)return"";let t=e;return t=t.replace(/^#+\s*/gm,""),t=t.replace(/\*{1,3}/g,""),t=t.replace(/\*\*(.*?)\*\*/g,"$1"),t=t.replace(/\*(.*?)\*/g,"$1"),t=t.replace(/__(.*?)__/g,"$1"),t=t.replace(/_(.*?)_/g,"$1"),t}function loadNews(){alert("جارٍ تحديث الأخبار... (هذه وظيفة تجريبية)")}function checkQuiz(){const e=Array.from(document.querySelectorAll(".q1:checked")).map((e=>e.value)),t=["types","genes","ecosystems"].every((t=>e.includes(t)))&&3===e.length,n=document.getElementById("quiz-result");t?(n.innerHTML="ممتاز! إجابتك صحيحة ✅ — جميع العناصر الثلاثة صحيحة",n.style.color="#00a86b"):(n.innerHTML="حاول مرة تانية — ركز على ثلاثة أنواع: أنواع، تنوع جيني، ونظم بيئية.",n.style.color="#e74c3c")}function showMoreLessons(){alert("سيتم إضافة المزيد من الدروس قريبًا! يمكنك متابعة الأخبار لمعرفة المستجدات.")}let map;function initMap(){map=L.map("map").setView([26.8206,30.8025],6),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);[{lat:30.0444,lng:31.2357,title:"القاهرة",type:"تلوث هوائي",desc:"مستوى تلوث مرتفع في المنطقة"},{lat:31.2001,lng:29.9187,title:"الإسكندرية",type:"تلوث مائي",desc:"تلوث في مياه البحر المتوسط"},{lat:24.0889,lng:32.8998,title:"أسوان",type:"محمية طبيعية",desc:"منطقة غنية بالتنوع البيولوجي"},{lat:28.0339,lng:1.6596,title:"الوادي الجديد",type:"مشروع تشجير",desc:"مشروع لزراعة الأشجار في الصحراء"},{lat:27.2579,lng:33.8116,title:"البحر الأحمر",type:"شعاب مرجانية",desc:"جهود لحماية الشعاب المرجانية"}].forEach((e=>{const t=L.divIcon({html:`<div style="background-color: ${e.type.includes("تلوث")?"#e74c3c":"#2ecc71"}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>`,className:"custom-marker",iconSize:[20,20],iconAnchor:[10,10]});L.marker([e.lat,e.lng],{icon:t}).addTo(map).bindPopup(`\n                    <h3>${e.title}</h3>\n                    <p><strong>النوع:</strong> ${e.type}</p>\n                    <p>${e.desc}</p>\n                `)}))}function initCharts(){const e=document.getElementById("airQualityChart").getContext("2d");new Chart(e,{type:"line",data:{labels:["يناير","فبراير","مارس","أبريل","مايو","يونيو"],datasets:[{label:"مؤشر جودة الهواء",data:[65,59,80,81,56,72],borderColor:"#00a86b",backgroundColor:"rgba(0, 168, 107, 0.1)",tension:.3,fill:!0}]},options:{responsive:!0,plugins:{legend:{position:"top"}}}});const t=document.getElementById("biodiversityChart").getContext("2d");new Chart(t,{type:"doughnut",data:{labels:["نباتات","حيوانات","طيور","كائنات دقيقة"],datasets:[{data:[30,25,20,25],backgroundColor:["#00a86b","#0b6b3a","#1fc49b","#e7f3ed"]}]},options:{responsive:!0,plugins:{legend:{position:"bottom"}}}});const n=document.getElementById("pollutionChart").getContext("2d");new Chart(n,{type:"bar",data:{labels:["هواء","ماء","تربة","ضوضاء","بلاستيك"],datasets:[{label:"مستوى التلوث",data:[65,59,80,81,56],backgroundColor:["rgba(255, 99, 132, 0.7)","rgba(54, 162, 235, 0.7)","rgba(255, 206, 86, 0.7)","rgba(75, 192, 192, 0.7)","rgba(153, 102, 255, 0.7)"]}]},options:{responsive:!0,plugins:{legend:{display:!1}}}})}function animateCount(e,t,n=1400){const o=document.getElementById(e);if(!o)return;let a=0;const l=Math.ceil(t/(n/30)),s=setInterval((()=>{a+=l,a>=t&&(a=t,clearInterval(s)),o.textContent=a.toLocaleString()}),30)}AOS.init({duration:800,once:!1,offset:80}),document.getElementById("ai-btn").addEventListener("click",(async()=>{const e=document.getElementById("ai-input").value.trim(),t=document.getElementById("ai-output"),n=document.getElementById("ai-loading");if(e){n.style.display="block",t.textContent="";try{const n=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer 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"},body:JSON.stringify({model:"tngtech/deepseek-r1t2-chimera:free",messages:[{role:"system",content:" أنت مساعد بيئي متخصص في الإجابة على الأسئلة المتعلقة بالبيئة والتنوع البيولوجي والحفاظ على الطبيعة في مصر والوطن العربي. قدم إجابات مفيدة وواضحة باللغة العربية بدون استخدام رموز Markdown مثل # أو * أو **. تم تطويرك بواسطة يوسف محمد ابراهيم ف لو حد سالك مين اللي عملك تجاوب بيوسف محمد ابراهيم علي "},{role:"user",content:e}],max_tokens:1500})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);let o=(await n.json()).choices[0].message.content;o=cleanAIResponse(o),t.innerHTML=`<p>${o.replace(/\n/g,"<br>")}</p>`}catch(n){console.error("Error calling AI API:",n);let o="";o=e.includes("كيف")&&e.includes("التنوع")?"حافظ على المواطن الطبيعية، دعم المشروعات المحلية، وقلل من التلوث البلاستيكي. يمكنك أيضًا المشاركة في حملات التشجير والتوعية البيئية.":e.includes("تلوث")||e.includes("ماء")||e.includes("هواء")?"نظام فلترة، حدد مصدر التلوث، وبلّغ الجهات المحلية. يمكنك رفع صورة في قسم البلاغات. كما يمكنك تقليل استخدام المواد البلاستيكية ذات الاستخدام الواحد.":e.includes("ازاي")||e.includes("كيف")?"ابدأ بخطوات صغيرة: تقليل استخدام البلاستيك، زرع شجرة، والمشاركة في حملات تنظيف. يمكنك أيضًا توعية الأصدقاء والعائلة بأهمية الحفاظ على البيئة.":"عذرًا، حدث خطأ في الاتصال بالخادم. يرجى المحاولة مرة أخرى لاحقًا.",t.textContent=cleanAIResponse(o)}finally{n.style.display="none"}}else t.textContent="من فضلك اكتب سؤالك أولاً"})),document.addEventListener("DOMContentLoaded",(()=>{animateCount("trees-count",2450),animateCount("clean-count",78),animateCount("species-count",520),initMap(),initCharts(),document.getElementById("load-news-btn").addEventListener("click",loadNews)}));
